@(
	dashboard: com.lucidchart.open.nark.models.records.Dashboard,
	graphs: List[com.lucidchart.open.nark.models.records.Graph],
	targets: List[com.lucidchart.open.nark.models.records.Target]
)(
	implicit
	request: com.lucidchart.open.nark.request.AppRequest[_],
	userOption: Option[com.lucidchart.open.nark.models.records.User]
)
@import play.api.libs.json.Json
@import com.lucidchart.open.nark.controllers.{routes=>narkRoutes}
@import com.lucidchart.open.nark.views
@import com.lucidchart.open.nark.models.records.Target
@import com.lucidchart.open.nark.models.records.Graph
@import com.lucidchart.open.nark.models.records.Dashboard

@com.lucidchart.open.nark.views.html.layouts.main(dashboard.name, List("js/dashboard.js", "jquery-timepicker-1.3.1/jquery-ui-timepicker-addon.js", "js/dygraph-combined.js"), List("jquery-timepicker-1.3.1/jquery-ui-timepicker-addon.css"), userOption = userOption){
	<style type="text/css">
		.container,
		.navbar-fixed-top .container,
		.navbar-static-top .container,
		.navbar-fixed-bottom .container { width: 95%; }

		.ui_tpicker_timezone select {
			width: 100px;
		}

		.ui-timepicker-div  {
			font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
			font-size: 14px;
		}

		#options-container .form-inline label {
			width: 100px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		#options-container .field-container {
			margin: 12px 0;
		}

		#allgraphs {
			margin: 0 -10px 0 -12px;
			position: relative;
		}

		#allgraphs.g1 .graph-wrapper { width: 100%; }
		#allgraphs.g2 .graph-wrapper { width: 50%; }
		#allgraphs.g3 .graph-wrapper { width: 33.33%; }
		#allgraphs.g4 .graph-wrapper { width: 25%; }
		#allgraphs.g5 .graph-wrapper { width: 20%; }
		#allgraphs.g6 .graph-wrapper { width: 16.66%; }

		.graph-wrapper {
			overflow: hidden;
			padding: 10px;
			box-sizing: border-box;
		}
		.graph-wrapper .well {
			margin: 0;
		}
		.graph-caption {
			width: 100%;
			height: 20px;
			text-align: center;
		}
		svg {
			width: 100%;
			height: 100%;
		}
	</style>

	<script type="text/javascript">
		var dashboard = @Html(views.models.dashboard(dashboard).toString);
		var dashKey = 'dashboard-' + dashboard['id'] + '-';
		var graphs = @Html(Json.toJson(graphs.filter(!_.deleted).map(views.models.graph(_))).toString);
		var targets = @Html(Json.toJson(targets.filter { target =>
			!target.deleted && graphs.foldLeft(true) { (active, graph) => 
				if (graph.id == target.graphId && graph.deleted) {
					false
				}
				else {
					active
				}
			}
		}.map(views.models.target(_))).toString);

		var dateFormat = "mm/dd/yy";
		var timeFormat = "HH:mmz";

		var localStorageStartDateKeys = ["dashboard-" + dashboard.id + "-custom-start", "dashboard-default-custom-start"];
		var localStorageEndDateKeys = ["dashboard-" + dashboard.id + "-custom-end", "dashboard-default-custom-end"];
		var localStorageColumnCountKeys = ["dashboard-" + dashboard.id + "-columns", "dashboard-default-columns"];
		var localStorageRefreshRateKeys = ["dashboard-" + dashboard.id + "-refresh", "dashboard-default-refresh"];
		var localStorageDateRangeKeys = ["dashboard-" + dashboard.id + "-daterange", "dashboard-default-daterange"];
		var localStorageOptionsPanelKeys = ["dashboard-" + dashboard.id + "-optionspanel", "dashboard-default-optionspanel"];

		var allGraphIds = [];
		$.map(graphs, function(graph) {
			allGraphIds.push(graph.id);
		});

		var zoomingToSelection = false;
		var lineGraphs = {};
		function redrawGraph(id) {
			if (graphData[id]) {
				var data = graphData[id];
				var element = "graph-" + id + " svg";
				var graph = $.grep(graphs, function(graph) {
					return graph["id"] == id;
				})[0];

				var graphOptions = {
					drawCallback: function(me, initial) {
						if (zoomingToSelection || initial) { return; }
						zoomingToSelection = true;
						var range = me.xAxisRange();
						$.map(graphs, function(g) {
							if (g.id == graph.id) { return; }
							if (lineGraphs.hasOwnProperty(g.id)) {
								lineGraphs[g.id].updateOptions({
									dateWindow: range
								});
							}
						});
						zoomingToSelection = false;
					}
				};

				switch (graph["type"]) {
					case "Stacked":
						lineGraphs[graph["id"]] = plotStackedGraph(element, data, graphOptions);
						break;
					case "Normal":
					default:
						lineGraphs[graph["id"]] = plotLineGraph(element, data, graphOptions);
						break;
				}
			}
		}

		var redrawGraphs = {};
		function queueRedrawGraph(id) {
			redrawGraphs[id] = true;

			setTimeout(function() {
				if (redrawGraphs[id]) {
					redrawGraphs[id] = false;
					redrawGraph(id);
				}
			}, 1);
		}

		function queueRedrawAllGraphs() {
			$.map(graphs, function(graph) {
				queueRedrawGraph(graph["id"]);
			});
		}

		var dataRequests = {};
		var graphData = {};
		function refreshData(graphIds) {
			var updatedTargets = getUpdatedTargets();

			$.map(graphs, function(graph) {
				if ($.inArray(graph['id'], graphIds) == -1) {
					return;
				}

				var data = {};

				if (dateRange["type"] == "custom") {
					data["start"] = Math.floor(dateRange["start"].getTime() / 1000);
					data["end"] = Math.floor(dateRange["end"].getTime() / 1000);
				}
				else {
					data["seconds"] = dateRange["seconds"];
				}

				var count = 0;
				$.map(updatedTargets, function(target) {
					if (target["graphId"] == graph["id"]) {
						data['target[' + (count++) + ']'] = target['target'];
					}
				});

				if (dataRequests[graph["id"]]) {
					dataRequests[graph["id"]].abort();
				}

				dataRequests[graph["id"]] = $.ajax({
					"type": "GET",
					"url": "/graphite/datapoints",
					"data": data,
					"dataType": "json",
					"timeout": 300000,
					"complete": function(xhr, status) {
						dataRequests[graph["id"]] = false;
					},
					"success": function(data) {
						graphData[graph["id"]] = data;
						queueRedrawGraph(graph["id"]);
					},
					"failure": function(data) {
						console.log("Failed to retrieve graphite data", data);
					}
				});
			});
		}

		function regexIndexOf(string, regex, startpos) {
			var indexOf = string.substring(startpos || 0).search(regex);
			return (indexOf >= 0) ? (indexOf + (startpos || 0)) : indexOf;
		}

		function getUpdatedTargets() {
			var variables = [];
			$('#variables-group input').each(function() {
				variables.push({'key': $(this).attr('key'), 'value': $(this).val()});
			});
			$('#variables-group select').each(function() {
				variables.push({'key': $(this).attr('key'), 'value': $(this).val()});
			});

			var updatedTargets = [];
			$.map(targets, function(target) {
				var parts = target['target'].split("%");
				for (var i = 1; i < parts.length; i += 2) {
					parts[i] = parts[i].split(/=|\|/)[0];
				}

				$.map(variables, function(variable) {
					for (var i = 1; i < parts.length; i += 2) {
						if (parts[i] == variable['key']) {
							parts[i] = variable['value'];
						}
					}
				});

				updatedTargets.push(
					{
						'graphId': target['graphId'],
						'target': parts.join("")
					}
				);
			});

			return updatedTargets;
		}

		function getAffectedGraphs(changedVariable) {
			var graphIds = [];
			$.map(targets, function(target) {
				if (target['target'].indexOf('%' + changedVariable) != -1) {
					$.map(graphs, function(graph) {
						if (graph['id'] == target['graphId']) {
							graphIds.push(graph['id']);
						}
					});
				}
			});

			return graphIds;
		}

		var needRefreshData = false;
		var graphsToRefresh = [];
		function queueRefreshData(graphIds) {
			graphIds = typeof graphIds !== 'undefined' ? graphIds : allGraphIds; 
			
			$.map(graphIds, function(graphId) {
				if ($.inArray(graphId, graphsToRefresh) == -1) {
					graphsToRefresh.push(graphId);
				}
			});
			needRefreshData = true;
			setTimeout(function() {
				if (needRefreshData) {
					needRefreshData = false;
					refreshData(graphsToRefresh);
					graphsToRefresh = [];
				}
			}, 1);
		}

		function adjustGraphHeights() {
			var width = $("#allgraphs .graph-wrapper").width();
			$("#allgraphs .graph-container").css('height', Math.floor((width - 20) * 0.66) + "px");
			queueRedrawAllGraphs();
		}

		function setOptionsPanel(visibility) {
			if(visibility == "hidden") {
				$("#options-container").slideUp();
			} else {
				$("#options-container").slideDown();
			}
		}

		var currentColumnCount = null;
		function setColumnCount(count) {
			currentColumnCount = count;
			$("#column-group button.active").removeClass("active");
			$("#column-group button[data='" + count + "']").addClass("active");
			$("#allgraphs").removeClass("g1 g2 g3 g4 g5 g6").addClass("g" + count);
			adjustGraphHeights();
		}

		var refreshRateSeconds = null;
		var refreshTimer = null;
		function refreshTimerTick() {
			if (refreshRateSeconds != "disable") {
				queueRefreshData();
				refreshTimer = setTimeout(refreshTimerTick, refreshRateSeconds * 1000);
			}
		}

		function setRefreshRate(seconds) {
			$("#refreshrate-group button.active").removeClass("active");
			$("#refreshrate-group button[data='" + seconds + "']").addClass("active");

			if (refreshTimer) {
				clearTimeout(refreshTimer);
				refreshTimer = null;
			}

			// updating a graph for a static time period seems like a waste... change it to 1h
			if (seconds != "disable" && dateRange["type"] == "custom") {
				setDateRange(3600);
			}

			refreshRateSeconds = seconds;
			refreshTimerTick();
		}

		var dateRange = { "type": null };
		function setDateRange(seconds) {
			$("#daterange-group button.active").removeClass("active");
			$("#daterange-group button[data='" + seconds + "']").addClass("active");

			if (seconds == "custom") {
				$("#custom-daterange-group").slideDown();
				if (dateRange["type"] != "custom") {
					dateRange = {
						"type": "custom",
						"start": null,
						"end": null
					};

					updateCustomDates();

					// updating a graph for a static time period seems like a waste... disable it.
					if (refreshRateSeconds != "disable") {
						setRefreshRate("disable");
					}
				}
			}
			else {
				$("#custom-daterange-group").slideUp();
				dateRange = {
					"type": "recent",
					"seconds": seconds
				};
			}

			queueRefreshData();
		}

		function updateCustomDates() {
			var newStart = $("#custom-daterange-start-input").datepicker("getDate");
			var newEnd   = $("#custom-daterange-end-input").datepicker("getDate");

			if (newStart != dateRange["start"]) {
				dateRange["start"] = newStart;
				queueRefreshData();
			}
			if (newEnd != dateRange["end"]) {
				dateRange["end"] = newEnd;
				queueRefreshData();
			}
		}

		function setLocalStorage(keys, value) {
			if (window.localStorage) {
				for (var i = 0; i < keys.length; i++) {
					var key = keys[i];
					window.localStorage[key] = value;
				}
			}
		}

		function fromLocalStorage(keys, defaultValue) {
			if (window.localStorage) {
				for (var i = 0; i < keys.length; i++) {
					var key = keys[i];
					if (window.localStorage.hasOwnProperty(key)) {
						return window.localStorage[key];
					}
				}
			}

			return defaultValue;
		}

		function fromLocalStorageInt(keys, defaultValue) {
			return parseInt(fromLocalStorage(keys, defaultValue), 10);
		}

		$(document).resize(function() {
			adjustGraphHeights();
		});

		$(document).ready(function() {
			$("#optiontoggler").click(function(event) {
				var visibility = fromLocalStorage(localStorageOptionsPanelKeys, "visible");
			
				if(visibility == "visible") {
					visibility = "hidden";
				} else {
					visibility = "visible";
				}

				setLocalStorage(localStorageOptionsPanelKeys, visibility);
				setOptionsPanel(visibility);
			});

			$("#refreshnow").click(function(event) {
				queueRefreshData();
			});

			$("#column-group button").click(function(event) {
				var count = parseInt($(event.target).attr("data"), 10);
				setLocalStorage(localStorageColumnCountKeys, count);
				setColumnCount(count);
			});

			$("#refreshrate-group button").click(function(event) {
				var seconds = $(event.target).attr("data");
				if (seconds != "disable") {
					seconds = parseInt(seconds, 10);
				}
				setLocalStorage(localStorageRefreshRateKeys, seconds);
				setRefreshRate(seconds);
			});

			$("#daterange-group button").click(function(event) {
				var seconds = $(event.target).attr("data");
				if (seconds != "custom") {
					seconds = parseInt(seconds, 10);
				}
				setLocalStorage(localStorageDateRangeKeys, seconds);
				setDateRange(seconds);
			});

			$("#custom-daterange-start-input").datetimepicker({
				"dateFormat": dateFormat,
				"timeFormat": timeFormat,
				"onSelect": function(datetime, target) {
					var date = $("#custom-daterange-start-input").datepicker("getDate");
					setLocalStorage(localStorageStartDateKeys, date.getTime());
					updateCustomDates();
				}
			});

			$("#custom-daterange-end-input").datetimepicker({
				"dateFormat": dateFormat,
				"timeFormat": timeFormat,
				"onSelect": function(datetime, target) {
					var date = $("#custom-daterange-end-input").datepicker("getDate");
					setLocalStorage(localStorageEndDateKeys, date.getTime());
					updateCustomDates();
				}
			});

			// date picker keeps showing up under the active option buttons
			$("#ui-datepicker-div").css("z-index", 5);

			// also toggle options slider
			var initialStart = fromLocalStorageInt(localStorageStartDateKeys, new Date().getTime() - 86400000);
			$("#custom-daterange-start-input").datepicker("setDate", new Date(initialStart));
			
			var initialEnd = fromLocalStorageInt(localStorageEndDateKeys, new Date().getTime());
			$("#custom-daterange-end-input").datepicker("setDate", new Date(initialEnd));
			updateCustomDates();

			setColumnCount(fromLocalStorageInt(localStorageColumnCountKeys, 3));
			setRefreshRate(fromLocalStorage(localStorageRefreshRateKeys, 60));
			setDateRange(fromLocalStorage(localStorageDateRangeKeys, 3600));
			setOptionsPanel(fromLocalStorage(localStorageOptionsPanelKeys, "visible"));

			var alreadyDisplayedVariables = [];
			var selectVariables = [];
			$.map(targets, function(target) {
				if (target['target'].indexOf('%') != -1) {
					var targetPieces = target['target'].split('%');
					for (var i = 1; i < targetPieces.length; i = i + 2) {
						if (targetPieces[i].indexOf('|') != -1) {
							variablePieces = targetPieces[i].split('|');
							
							if ($('#' + variablePieces[0]).length == 0) {
								$('#variables-group').append('<div class="row field-container"><label rel="tooltip" title="' + variablePieces[0] + '" for="' + variablePieces[0] + '"><strong>' + variablePieces[0] + '</strong></label><select id="' + variablePieces[0] + '" name="' + variablePieces[0] + '" key="' + variablePieces[0] + '"></select></div>');
								selectVariables.push(variablePieces[0]);
							}

							for (var j = 1; j < variablePieces.length; j++) {
								if ($('#' + variablePieces[0] + ' option[value="' + variablePieces[j] + '"]').length == 0) {

									$('#' + variablePieces[0]).append('<option value="' + variablePieces[j] + '">' + variablePieces[j] + '</option>');
								}
							}
							$('#' + variablePieces[0]).change(function(event) {
								setLocalStorage([dashKey + $(this).attr('key')], $(this).val());
								var graphIds = getAffectedGraphs($(this).attr('key'));
								queueRefreshData(graphIds);
							});
						}
						else {
							var variablePieces = targetPieces[i].split('=');
							var defaultValue = fromLocalStorage([dashKey + variablePieces[0]], (variablePieces.length == 2) ? variablePieces[1] : '');
							if ($.inArray(variablePieces[0], alreadyDisplayedVariables) == -1) {
								$('#variables-group').append('<div class="row field-container"><label rel="tooltip" title="' + variablePieces[0] + '" for="' + variablePieces[0] + '"><strong>' + variablePieces[0] +'</strong></label><input id="' + variablePieces[0] + '" name="' + variablePieces[0] + '" type="text" class="span9 input-large" key="' + variablePieces[0] + '" value="' + defaultValue + '" /></div>');

								$('#' + variablePieces[0]).focusout(function() {
									setLocalStorage([dashKey + $(this).attr('key')], $(this).val());
									var graphIds = getAffectedGraphs($(this).attr('key'));
									queueRefreshData(graphIds);
								});
								
								alreadyDisplayedVariables.push(variablePieces[0]);
							}
						}
					}
				}
			});

			$.map(selectVariables, function(variable) {
				var defaultValue = fromLocalStorage([dashKey + variable], '');
				if (defaultValue != '') {
					$('#' + variable + ' option[value="' + defaultValue + '"]').attr('selected', 'selected');
				}
			});
		});
	</script>

	<h3>
		@dashboard.name
		@if(userOption.isDefined && userOption.get.id == dashboard.userId) {
			<a href="@narkRoutes.DashboardsController.manage(dashboard.id)" class="btn">Manage</a>
		}
		<a href="#" id="optiontoggler" class="btn">Options</a>
		<a href="#" id="refreshnow" class="btn">Refresh</a>
	</h3>

	<div class="clearfix">
		<div id="options-container" class="well">
			<div class="row-fluid">
				<div class="span6">
					<div id="column-group" class="field-container">
						<div class="form-inline">
							<label><strong>Columns</strong></label>
							<div class="btn-group">
								<button class="btn" data="1">1</button>
								<button class="btn" data="2">2</button>
								<button class="btn" data="3">3</button>
								<button class="btn" data="4">4</button>
								<button class="btn" data="5">5</button>
								<button class="btn" data="6">6</button>
							</div>
						</div>
					</div>
					<div id="refreshrate-group" class="field-container">
						<div class="form-inline">
							<label><strong>Refresh Rate</strong></label>
							<div class="btn-group">
								<button class="btn" data="disable">Disable</button>
							</div>
							<div class="btn-group">
								<button class="btn" data="30">30s</button>
								<button class="btn" data="60">1m</button>
								<button class="btn" data="12">2m</button>
								<button class="btn" data="300">5m</button>
								<button class="btn" data="600">10m</button>
							</div>
						</div>
					</div>
					<div id="daterange-group" class="field-container">
						<div class="form-inline">
							<label><strong>Time Range</strong></label>
							<div class="btn-group">
								<button class="btn" data="custom">Custom</button>
							</div>
							<div class="btn-group">
								<button class="btn" data="1800">30m</button>
								<button class="btn" data="3600">1h</button>
								<button class="btn" data="21600">6h</button>
								<button class="btn" data="43200">12h</button>
								<button class="btn" data="86400">1d</button>
								<button class="btn" data="604800">7d</button>
								<button class="btn" data="2419200">28d</button>
								<button class="btn" data="7776000">90d</button>
							</div>
						</div>
					</div>
					<div id="custom-daterange-group" class="field-container" style="display: none">
						<div class="form-inline">
							<label><strong>Custom Dates</strong></label>
							<input type="text" id="custom-daterange-start-input" placeholder="Start Date">
							<input type="text" id="custom-daterange-end-input" placeholder="End Date">
						</div>
					</div>
				</div>
				<div class="span6">
					<div id="variables-group" class="controls form-inline"></div>
				</div>
			</div>
		</div>
		<div id="allgraphs" class="clearfix">
			@graphs.filter(!_.deleted).sortWith(_.sort < _.sort).map { graph =>
				<div id="graph-@graph.id-wrapper" class="pull-left graph-wrapper">
					<div class="well">
						<div class="graph-container" id="graph-@graph.id.toString">
							<svg></svg>
						</div>
						<div class="graph-caption">
							<strong>@graph.name</strong>
						</div>
					</div>
				</div>
			}
		</div>
	</div>
}
