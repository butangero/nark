@(
	dashboard: com.lucidchart.open.nark.models.records.Dashboard,
	graphs: List[com.lucidchart.open.nark.models.records.Graph],
	targets: List[com.lucidchart.open.nark.models.records.Target],
	tags: List[com.lucidchart.open.nark.models.records.DashboardTag],
	owner: Option[com.lucidchart.open.nark.models.records.User],
	dataGranularitySeconds: Int
)(
	implicit
	request: com.lucidchart.open.nark.request.AppRequest[_],
	userOption: Option[com.lucidchart.open.nark.models.records.User]
)
@import play.api.libs.json.Json
@import com.lucidchart.open.nark.controllers.{routes=>narkRoutes}
@import com.lucidchart.open.nark.views
@import com.lucidchart.open.nark.models.records.Target
@import com.lucidchart.open.nark.models.records.Graph
@import com.lucidchart.open.nark.models.records.Dashboard
@import com.lucidchart.open.nark.utils.Graphite

@com.lucidchart.open.nark.views.html.layouts.main(dashboard.name, List("js/dashboard.js", "jquery-timepicker-1.3.1/jquery-ui-timepicker-addon.js", "js/dygraph-combined.js"), List("css/dashboard.css", "jquery-timepicker-1.3.1/jquery-ui-timepicker-addon.css" ), userOption = userOption){
	<script type="text/javascript">
		var granularitySeconds = @dataGranularitySeconds;
		var autoIntervalPointsPerPixel = 0.25;
		var dashboard = @Html(views.models.dashboard(dashboard).toString);
		var dashKey = 'dashboard-' + dashboard['id'] + '-';
		var graphs = @Html(Json.toJson(graphs.filter(!_.deleted).map(views.models.graph(_))).toString);
		var targets = @Html(Json.toJson(targets.filter { target =>
			!target.deleted && graphs.foldLeft(true) { (active, graph) => 
				if (graph.id == target.graphId && graph.deleted) {
					false
				}
				else {
					active
				}
			}
		}.map(views.models.target(_))).toString);
		var graphiteBaseUrl = '@Graphite.baseUrl';

		var dataRequests = {};
		var graphData = {};
		function refreshData(graphIds) {
			var updatedTargets = getUpdatedTargets();

			$.map(graphs, function(graph) {
				if ($.inArray(graph['id'], graphIds) == -1) {
					return;
				}

				var data = {};

				//reset the graphite link under the graph
				var graphUrl = graphiteBaseUrl;
				graphUrl += '/render?title=' + graph['name'] + '&width=650&height=400&';

				var graphSeconds = null;
				if (dateRange["type"] == "custom") {
					data["from"] = Math.floor(dateRange["start"].getTime() / 1000);
					data["to"] = Math.floor(dateRange["end"].getTime() / 1000);
					graphSeconds = Math.abs(data["to"] - data["from"]);
					graphUrl += 'from=' + data['from'] + '&to=' + data['to'];
				}
				else {
					data["seconds"] = dateRange["seconds"];
					graphSeconds = data["seconds"];
					graphUrl += 'from=-' + data['seconds'] + 's';
				}

				var intervalString = null;
				if (summarizer == "auto") {
					// the number of pixels isn't exact, because of axis labels and graph padding, but it will be close enough.
					var pixels = getGraphWidth();

					// calculate number of data points based on interval, pixels, and the magic number.
					var intervalSeconds = graphSeconds / (autoIntervalPointsPerPixel * pixels);

					// adjust to a multiple of granularitySeconds
					intervalSeconds = intervalSeconds + (granularitySeconds - intervalSeconds % granularitySeconds);

					// require at least granularitySeconds seconds
					intervalSeconds = Math.max(intervalSeconds, granularitySeconds);

					if (intervalSeconds > granularitySeconds) {
						intervalString = intervalSeconds + "s";
					}
				}
				else if (summarizer == "all") {
					// do nothing, get all data points.
					// summarization function will not be applied below.
				}
				else {
					intervalString = summarizer + "s";
				}

				var count = 0;
				$.map(targets, function(target) {
					if (target["graphId"] == graph["id"]) {
						var updatedTarget = updatedTargets[target['id']];

						var summarizedTarget = updatedTarget;
						if (intervalString) {
							summarizedTarget = "summarize(" + updatedTarget + ",'" + intervalString + "','" + target['summarizer'] + "')";
						}

						data['target[' + (count++) + ']'] = summarizedTarget;
						graphUrl += '&target=' + summarizedTarget;
					}
				});

				if (dataRequests[graph["id"]]) {
					dataRequests[graph["id"]].abort();
				}

				$('#graph-link-' + graph['id']).attr('href', graphUrl);

				//show that the graph is reloading
				$('#loading-' + graph['id']).show(250);

				dataRequests[graph["id"]] = $.ajax({
					"type": "GET",
					"url": "/graphite/datapoints",
					"data": data,
					"dataType": "json",
					"timeout": 300000,
					"complete": function(xhr, status) {
						dataRequests[graph["id"]] = false;
					},
					"success": function(data) {
						if(!data || data.length == 0) {
							showGraphError(graph["id"], "No data available for this graph over the selected time period.");
						} else {
							graphData[graph["id"]] = data;
							queueRedrawGraph(graph["id"]);
							removeGraphError(graph["id"]);
						}
					},
					"failure": function(data) {
						showGraphError(graph["id"], "Failed to retrieve graphite data: " + data);
						console.log("Failed to retrieve graphite data", data);
					}
				});
			});
		}


	</script>

	<h3>
		@dashboard.name
		@if(userOption.isDefined && userOption.get.id == dashboard.userId) {
			<a href="@narkRoutes.DashboardsController.manage(dashboard.id)" class="btn">Manage</a>
		}
		<a href="#" id="optiontoggler" class="btn">Options</a>
		<a href="#" id="refreshnow" class="btn">Refresh</a>
		<a href="#" id="infotoggler" class="btn">Info</a>
	</h3>
	<div class="clearfix">
		<div id="info-container" class="well container">
			<div class="row-fluid">
				<div class="span6">
					<div id="tags-group" class="field-container">
						<div class="form-inline">
							<label><strong>Tags</strong></label>
							<div class="info-group">
							@tags.map{dashboardTag =>
								<a href="@narkRoutes.DashboardTagsController.tag(dashboardTag.tag)" class="btn btn-mini">@dashboardTag.tag</a>
							}
							</div>
						</div>
					</div>
					<div id="owner-group" class="field-container">
						<div class="form-inline">
							<label><strong>Owner</strong></label>
							<div class="info-group">
								@if(owner.isDefined) {
									@owner.get.name
									<a href="mailto:@owner.get.email">@owner.get.email</a>
								}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="options-container" class="well container">
			<div class="row-fluid">
				<div class="span6">
					<div id="column-group" class="field-container">
						<div class="form-inline">
							<label><strong>Columns</strong></label>
							<div class="btn-group">
								<button class="btn" data="1">1</button>
								<button class="btn" data="2">2</button>
								<button class="btn" data="3">3</button>
								<button class="btn" data="4">4</button>
								<button class="btn" data="5">5</button>
								<button class="btn" data="6">6</button>
							</div>
						</div>
					</div>
					<div id="refreshrate-group" class="field-container">
						<div class="form-inline">
							<label><strong>Refresh Rate</strong></label>
							<div class="btn-group">
								<button class="btn" data="disable">Disable</button>
							</div>
							<div class="btn-group">
								<button class="btn" data="30">30s</button>
								<button class="btn" data="60">1m</button>
								<button class="btn" data="12">2m</button>
								<button class="btn" data="300">5m</button>
								<button class="btn" data="600">10m</button>
							</div>
						</div>
					</div>
					<div id="daterange-group" class="field-container">
						<div class="form-inline">
							<label><strong>Time Range</strong></label>
							<div class="btn-group">
								<button class="btn" data="custom">Custom</button>
							</div>
							<div class="btn-group">
								<button class="btn" data="1800">30m</button>
								<button class="btn" data="3600">1h</button>
								<button class="btn" data="21600">6h</button>
								<button class="btn" data="43200">12h</button>
								<button class="btn" data="86400">1d</button>
								<button class="btn" data="604800">7d</button>
								<button class="btn" data="2419200">28d</button>
								<button class="btn" data="7776000">90d</button>
							</div>
						</div>
					</div>
					<div id="custom-daterange-group" class="field-container" style="display: none">
						<div class="form-inline">
							<label><strong>Custom Dates</strong></label>
							<input type="text" id="custom-daterange-start-input" placeholder="Start Date">
							<input type="text" id="custom-daterange-end-input" placeholder="End Date">
						</div>
					</div>
					<div id="summarizer-group" class="field-container">
						<div class="form-inline">
							<label><strong>Data Interval</strong></label>
							<div class="btn-group">
								<button class="btn" data="auto">Auto</button>
								<button class="btn" data="all">All</button>
							</div>
							<div class="btn-group">
								<button class="btn" data="60">1m</button>
								<button class="btn" data="1800">30m</button>
								<button class="btn" data="3600">1h</button>
								<button class="btn" data="43200">12h</button>
								<button class="btn" data="86400">1d</button>
								<button class="btn" data="604800">7d</button>
								<button class="btn" data="2592000">30d</button>
							</div>
						</div>
					</div>
				</div>
				<div class="span6">
					<div id="variables-group" class="controls form-inline"></div>
				</div>
			</div>
		</div>
		<div id="allgraphs" class="clearfix">
			@graphs.filter(!_.deleted).sortWith(_.sort < _.sort).map { graph =>
				<div id="graph-@graph.id-wrapper" class="pull-left graph-wrapper">
					<div class="well">
						<div class="graph-container" id="graph-@graph.id.toString">
							<div class="graph-error alert-error"></div>
							<svg></svg>
						</div>
						<div class="graph-caption">
							<strong><span id='loading-@graph.id' class="loading-text" style='display:none'>(<i class='icon-refresh' ></i> Loading...)</span> @graph.name</strong><br />
							<a id='graph-link-@graph.id.toString' class='small-text' href='' target=_blank>(Graphite)</a>
						</div>
					</div>
				</div>
			}
		</div>
	</div>
}
