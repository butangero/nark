@(
	dashboard: com.lucidchart.open.nark.models.records.Dashboard,
	graphs: List[com.lucidchart.open.nark.models.records.Graph],
	targets: List[com.lucidchart.open.nark.models.records.Target]
)(
	implicit
	request: com.lucidchart.open.nark.request.AppRequest[_],
	userOption: Option[com.lucidchart.open.nark.models.records.User]
)
@import play.api.libs.json.Json
@import com.lucidchart.open.nark.controllers.{routes=>narkRoutes}
@import com.lucidchart.open.nark.views
@import com.lucidchart.open.nark.models.records.Target
@import com.lucidchart.open.nark.models.records.Graph
@import com.lucidchart.open.nark.models.records.Dashboard

@com.lucidchart.open.nark.views.html.layouts.main(dashboard.name, List("js/dashboard.js", "js/d3/d3.v3.min.js", "js/nv.d3.min.js", "jquery-timepicker-1.3.1/jquery-ui-timepicker-addon.js"), List("css/nv.d3.css", "jquery-timepicker-1.3.1/jquery-ui-timepicker-addon.css"), userOption = userOption){
	<style type="text/css">
		.container,
		.navbar-fixed-top .container,
		.navbar-static-top .container,
		.navbar-fixed-bottom .container { width: 95%; }

		.ui_tpicker_timezone select {
			width: 100px;
		}

		.ui-timepicker-div  {
			font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
			font-size: 14px;
		}

		#options-container .form-inline label {
			width: 100px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		#options-container .field-container {
			margin: 12px 0;
		}

		#allgraphs {
			margin: 0 -10px 0 -12px;
			position: relative;
		}

		#allgraphs.g1 .graph-wrapper { width: 100%; }
		#allgraphs.g2 .graph-wrapper { width: 50%; }
		#allgraphs.g3 .graph-wrapper { width: 33.33%; }
		#allgraphs.g4 .graph-wrapper { width: 25%; }
		#allgraphs.g5 .graph-wrapper { width: 20%; }
		#allgraphs.g6 .graph-wrapper { width: 16.66%; }

		.graph-wrapper {
			overflow: hidden;
			padding: 10px;
			box-sizing: border-box;
		}
		.graph-wrapper .well {
			margin: 0;
		}
		.graph-caption {
			width: 100%;
			height: 20px;
			text-align: center;
		}
		svg {
			width: 100%;
			height: 100%;
		}
	</style>

	<script type="text/javascript">
		var dashboard = @Html(views.models.dashboard(dashboard).toString);
		var graphs = @Html(Json.toJson(graphs.filter(!_.deleted).map(views.models.graph(_))).toString);
		var targets = @Html(Json.toJson(targets.filter(!_.deleted).map(views.models.target(_))).toString);

		var dateFormat = "mm/dd/yy";
		var timeFormat = "HH:mmz";

		var localStorageStartDateKeys = ["dashboard-" + dashboard.id + "-custom-start", "dashboard-default-custom-start"];
		var localStorageEndDateKeys = ["dashboard-" + dashboard.id + "-custom-end", "dashboard-default-custom-end"];
		var localStorageColumnCountKeys = ["dashboard-" + dashboard.id + "-columns", "dashboard-default-columns"];
		var localStorageRefreshRateKeys = ["dashboard-" + dashboard.id + "-refresh", "dashboard-default-refresh"];
		var localStorageDateRangeKeys = ["dashboard-" + dashboard.id + "-daterange", "dashboard-default-daterange"];

		function redrawGraph(id) {
			if (graphData[id]) {
				var data = graphData[id];
				var element = "graph-" + id + " svg";
				var graph = $.grep(graphs, function(graph) {
					return graph["id"] == id;
				})[0];

				switch (graph["type"]) {
					case "Stacked":
						plotStackedGraph(element, data);
						break;
					case "Normal":
					default:
						plotLineGraph(element, data);
						break;
				}
			}
		}

		var redrawGraphs = {};
		function queueRedrawGraph(id) {
			redrawGraphs[id] = true;

			setTimeout(function() {
				if (redrawGraphs[id]) {
					redrawGraphs[id] = false;
					redrawGraph(id);
				}
			}, 1);
		}

		function queueRedrawAllGraphs() {
			$.map(graphs, function(graph) {
				queueRedrawGraph(graph["id"]);
			});
		}

		var graphData = {};
		function refreshData() {
			queueRedrawAllGraphs();

			$.map(graphs, function(graph) {
				var data = {};

				if (dateRange["type"] == "custom") {
					data["start"] = Math.floor(dateRange["start"].getTime() / 1000);
					data["end"] = Math.floor(dateRange["end"].getTime() / 1000);
				}
				else {
					data["seconds"] = dateRange["seconds"];
				}

				$.map(targets, function(target) {
					if (target["graphId"] == graph["id"]) {
						data["target[]"] = target["target"];
					}
				});

				$.ajax({
					"type": "GET",
					"url": "/graphite/datapoints",
					"data": data,
					"dataType": "json",
					"timeout": 300000,
					"success": function(data) {
						graphData[graph["id"]] = data;
						queueRedrawGraph(graph["id"]);
					},
					"failure": function(data) {
						console.log("Failed to retrieve graphite data", data);
					}
				});
			});
		}

		var needRefreshData = false;
		function queueRefreshData() {
			needRefreshData = true;
			setTimeout(function() {
				if (needRefreshData) {
					needRefreshData = false;
					refreshData();
				}
			}, 1);
		}

		function adjustGraphHeights() {
			var width = $("#allgraphs .graph-wrapper").width();
			$("#allgraphs .graph-container").css('height', Math.floor((width - 20) * 0.66) + "px");
			queueRedrawAllGraphs();
		}

		var currentColumnCount = null;
		function setColumnCount(count) {
			currentColumnCount = count;
			$("#column-group button.active").removeClass("active");
			$("#column-group button[data='" + count + "']").addClass("active");
			$("#allgraphs").removeClass("g1 g2 g3 g4 g5 g6").addClass("g" + count);
			adjustGraphHeights();
		}

		var refreshRateSeconds = null;
		var refreshTimer = null;
		function refreshTimerTick() {
			if (refreshRateSeconds != "disable") {
				queueRefreshData();
				refreshTimer = setTimeout(refreshTimerTick, refreshRateSeconds * 1000);
			}
		}

		function setRefreshRate(seconds) {
			$("#refreshrate-group button.active").removeClass("active");
			$("#refreshrate-group button[data='" + seconds + "']").addClass("active");

			if (refreshTimer) {
				clearTimeout(refreshTimer);
				refreshTimer = null;
			}

			// updating a graph for a static time period seems like a waste... change it to 1h
			if (seconds != "disable" && dateRange["type"] == "custom") {
				setDateRange(3600);
			}

			refreshRateSeconds = seconds;
			refreshTimerTick();
		}

		var dateRange = { "type": null };
		function setDateRange(seconds) {
			$("#daterange-group button.active").removeClass("active");
			$("#daterange-group button[data='" + seconds + "']").addClass("active");

			if (seconds == "custom") {
				$("#custom-daterange-group").slideDown();
				if (dateRange["type"] != "custom") {
					dateRange = {
						"type": "custom",
						"start": null,
						"end": null
					};

					updateCustomDates();

					// updating a graph for a static time period seems like a waste... disable it.
					if (refreshRateSeconds != "disable") {
						setRefreshRate("disable");
					}
				}
			}
			else {
				$("#custom-daterange-group").slideUp();
				dateRange = {
					"type": "recent",
					"seconds": seconds
				};
			}

			queueRefreshData();
		}

		function updateCustomDates() {
			var newStart = $("#custom-daterange-start-input").datepicker("getDate");
			var newEnd   = $("#custom-daterange-end-input").datepicker("getDate");

			if (newStart != dateRange["start"]) {
				dateRange["start"] = newStart;
				queueRefreshData();
			}
			if (newEnd != dateRange["end"]) {
				dateRange["end"] = newEnd;
				queueRefreshData();
			}
		}

		function setLocalStorage(keys, value) {
			if (window.localStorage) {
				for (var i = 0; i < keys.length; i++) {
					var key = keys[i];
					window.localStorage[key] = value;
				}
			}
		}

		function fromLocalStorage(keys, defaultValue) {
			if (window.localStorage) {
				for (var i = 0; i < keys.length; i++) {
					var key = keys[i];
					if (window.localStorage.hasOwnProperty(key)) {
						return window.localStorage[key];
					}
				}
			}

			return defaultValue;
		}

		function fromLocalStorageInt(keys, defaultValue) {
			return parseInt(fromLocalStorage(keys, defaultValue), 10);
		}

		$(document).resize(function() {
			adjustGraphHeights();
		});

		$(document).ready(function() {
			$("#optiontoggler").click(function(event) {
				$("#options-container").slideToggle();
			});

			$("#column-group button").click(function(event) {
				var count = parseInt($(event.target).attr("data"), 10);
				setLocalStorage(localStorageColumnCountKeys, count);
				setColumnCount(count);
			});

			$("#refreshrate-group button").click(function(event) {
				var seconds = $(event.target).attr("data");
				if (seconds != "disable") {
					seconds = parseInt(seconds, 10);
				}
				setLocalStorage(localStorageRefreshRateKeys, seconds);
				setRefreshRate(seconds);
			});

			$("#daterange-group button").click(function(event) {
				var seconds = $(event.target).attr("data");
				if (seconds != "custom") {
					seconds = parseInt(seconds, 10);
				}
				setLocalStorage(localStorageDateRangeKeys, seconds);
				setDateRange(seconds);
			});

			$("#custom-daterange-start-input").datetimepicker({
				"dateFormat": dateFormat,
				"timeFormat": timeFormat,
				"onSelect": function(datetime, target) {
					var date = $("#custom-daterange-start-input").datepicker("getDate");
					setLocalStorage(localStorageStartDateKeys, date.getTime());
					updateCustomDates();
				}
			});

			$("#custom-daterange-end-input").datetimepicker({
				"dateFormat": dateFormat,
				"timeFormat": timeFormat,
				"onSelect": function(datetime, target) {
					var date = $("#custom-daterange-end-input").datepicker("getDate");
					setLocalStorage(localStorageEndDateKeys, date.getTime());
					updateCustomDates();
				}
			});

			// date picker keeps showing up under the active option buttons
			$("#ui-datepicker-div").css("z-index", 5);

			// also toggle options slider
			var initialStart = fromLocalStorageInt(localStorageStartDateKeys, new Date().getTime() - 86400000);
			$("#custom-daterange-start-input").datepicker("setDate", new Date(initialStart));
			
			var initialEnd = fromLocalStorageInt(localStorageEndDateKeys, new Date().getTime());
			$("#custom-daterange-end-input").datepicker("setDate", new Date(initialEnd));
			updateCustomDates();

			setColumnCount(fromLocalStorageInt(localStorageColumnCountKeys, 3));
			setRefreshRate(fromLocalStorageInt(localStorageRefreshRateKeys, 60));
			setDateRange(fromLocalStorageInt(localStorageDateRangeKeys, 3600));
		});
	</script>

	<h3>
		@dashboard.name
		@if(userOption.isDefined && userOption.get.id == dashboard.userId) {
			<a href="@narkRoutes.DashboardsController.manage(dashboard.id)" class="btn">Manage</a>
		}
		<a href="#" id="optiontoggler" class="btn">Options</a>
	</h3>

	<div class="clearfix">
		<div id="options-container" class="well">
			<div id="column-group" class="field-container">
				<div class="form-inline">
					<label><strong>Columns</strong></label>
					<div class="btn-group">
						<button class="btn" data="1">1</button>
						<button class="btn" data="2">2</button>
						<button class="btn" data="3">3</button>
						<button class="btn" data="4">4</button>
						<button class="btn" data="5">5</button>
						<button class="btn" data="6">6</button>
					</div>
				</div>
			</div>
			<div id="refreshrate-group" class="field-container">
				<div class="form-inline">
					<label><strong>Refresh Rate</strong></label>
					<div class="btn-group">
						<button class="btn" data="disable">Disable</button>
					</div>
					<div class="btn-group">
						<button class="btn" data="1">1s</button>
						<button class="btn" data="30">30s</button>
						<button class="btn" data="60">1m</button>
						<button class="btn" data="120">2m</button>
						<button class="btn" data="300">5m</button>
						<button class="btn" data="600">10m</button>
					</div>
				</div>
			</div>
			<div id="daterange-group" class="field-container">
				<div class="form-inline">
					<label><strong>Time Range</strong></label>
					<div class="btn-group">
						<button class="btn" data="custom">Custom</button>
					</div>
					<div class="btn-group">
						<button class="btn" data="3600">1h</button>
						<button class="btn" data="21600">6h</button>
						<button class="btn" data="43200">12h</button>
						<button class="btn" data="86400">1d</button>
						<button class="btn" data="604800">7d</button>
						<button class="btn" data="2419200">28d</button>
						<button class="btn" data="7776000">90d</button>
					</div>
				</div>
			</div>
			<div id="custom-daterange-group" class="field-container" style="display: none">
				<div class="form-inline">
					<label><strong>Custom Dates</strong></label>
					<input type="text" id="custom-daterange-start-input" placeholder="Start Date">
					<input type="text" id="custom-daterange-end-input" placeholder="End Date">
				</div>
			</div>
		</div>
		<div id="allgraphs" class="clearfix">
			@graphs.filter(!_.deleted).sortWith(_.sort < _.sort).map { graph =>
				<div id="graph-@graph.id-wrapper" class="pull-left graph-wrapper">
					<div class="well">
						<div class="graph-container" id="graph-@graph.id.toString">
							<svg></svg>
						</div>
						<div class="graph-caption">
							<strong>@graph.name</strong>
						</div>
					</div>
				</div>
			}
		</div>
	</div>
}
